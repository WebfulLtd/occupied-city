'use strict';

angular.module('occupied.services', [])

    .value('basePopulation', 1810037) // 1946 total, http://www.jewishvirtuallibrary.org/jsource/Society_&_Culture/israel_palestine_pop.html
    .value('baseArea', 6209)// km^2, approx for West Bank & Gaza - roughly the 'modern' Palestinian Territories
        // N.B. West Bank is ~5860km^2 - https://www.cia.gov/library/publications/the-world-factbook/geos/we.html
        // N.B. all of historical Palestine is more like 26,000km^2 - http://www.plands.org/articles/004.html

    .factory('CityData', function() {
        return {
            /**
             * Gets data for all cities. N.B. area is km^2 and is for the 'city' / centre.
             * Population estimate dates and sources are in comments.
             *
             * We should aim to use cities themselves rather than greater metro area for population & size.
             *
             * @returns object  All our data, keyed on city/country name.
             *
             * Keys include:
             *  `country` - optional bool, assume area is a city if it's missing or false
             *  `lat` for latitude
             *  `lng` for longitude
             *  `area` in km^2
             *  `coords` is a 3D array in a format ready to be handled as Polygon by Leaflet
             *  `multicoords` is a 4D array in a format ready to be handled as MultiPolygon
             *  `population` is an estimate of today's population in the area
             *
             * @private
             */
            _getAll: function() {
                return {
                    'United Kingdom': {
                        country: true,
                        lat: 51.5,
                        lng: -0.116667,
                        population: 64100000, // 2013 estimate - http://www.ons.gov.uk/ons/rel/pop-estimate/population-estimates-for-uk--england-and-wales--scotland-and-northern-ireland/2013/index.html
                        area: 243610,
                        multicoords: [[[[-5.661949,54.554603],[-6.197885,53.867565],[-6.95373,54.073702],[-7.572168,54.059956],[-7.366031,54.595841],[-7.572168,55.131622],[-6.733847,55.17286],[-5.661949,54.554603]]],[[[-3.005005,58.635],[-4.073828,57.553025],[-3.055002,57.690019],[-1.959281,57.6848],[-2.219988,56.870017],[-3.119003,55.973793],[-2.085009,55.909998],[-2.005676,55.804903],[-1.114991,54.624986],[-0.430485,54.464376],[0.184981,53.325014],[0.469977,52.929999],[1.681531,52.73952],[1.559988,52.099998],[1.050562,51.806761],[1.449865,51.289428],[0.550334,50.765739],[-0.787517,50.774989],[-2.489998,50.500019],[-2.956274,50.69688],[-3.617448,50.228356],[-4.542508,50.341837],[-5.245023,49.96],[-5.776567,50.159678],[-4.30999,51.210001],[-3.414851,51.426009],[-3.422719,51.426848],[-4.984367,51.593466],[-5.267296,51.9914],[-4.222347,52.301356],[-4.770013,52.840005],[-4.579999,53.495004],[-3.093831,53.404547],[-3.09208,53.404441],[-2.945009,53.985],[-3.614701,54.600937],[-3.630005,54.615013],[-4.844169,54.790971],[-5.082527,55.061601],[-4.719112,55.508473],[-5.047981,55.783986],[-5.586398,55.311146],[-5.644999,56.275015],[-6.149981,56.78501],[-5.786825,57.818848],[-5.009999,58.630013],[-4.211495,58.550845],[-3.005005,58.635]]]]
                    },
                    Beijing: {
                        lat: 39.916667,
                        lng: 116.383333,
                        population: 21500000, // 2014 - https://en.wikipedia.org/wiki/Beijing
                        area: 1368.32,
                        coords: [
                            [[116.293961,40.053112], [116.301270,40.075443], [116.306442,40.075493], [116.320648,40.070198], [116.339638,40.069386], [116.351547,40.069260], [116.354698,40.069500], [116.385727,40.077019], [116.406586,40.073322], [116.433792,40.065987], [116.448814,40.044556], [116.475800,40.043228], [116.498337,40.046211], [116.515503,40.046474], [116.518250,40.041283], [116.541595,40.028141], [116.557793,40.016876], [116.565628,39.988167], [116.558006,39.972324], [116.551033,39.944885], [116.550690,39.934853], [116.557899,39.918514], [116.564125,39.908905], [116.559448,39.889690], [116.542625,39.847557], [116.499023,39.833851], [116.477165,39.827999], [116.452843,39.808537], [116.450958,39.793236], [116.437912,39.800095], [116.394821,39.803261], [116.386414,39.789280], [116.374054,39.782158], [116.366928,39.792183], [116.352768,39.798248], [116.336975,39.827522], [116.329422,39.848480], [116.315002,39.858101], [116.286110,39.847221], [116.291656,39.810646], [116.278702,39.808762], [116.237221,39.834270], [116.233559,39.833344], [116.210838,39.833721], [116.208572,39.848679], [116.186943,39.863503], [116.169434,39.884220], [116.151840,39.897587], [116.127502,39.920666], [116.123428,39.926998], [116.146088,39.951332], [116.167160,39.976158], [116.166542,40.002102], [116.186623,40.009975], [116.197456,40.026581], [116.229515,40.043518], [116.244965,40.059155], [116.286278,40.047649], [116.290001,40.049999], [116.293961,40.053112]]
                        ]
                    },
                    Berlin: {
                        lat: 52.516667,
                        lng: 13.383333,
                        population: 3419623, // 2013 - https://www.statistik-berlin-brandenburg.de/Publikationen/OTab/2014/OT_A01-10-00_124_201311_BE.pdf
                        area: 891.85,
                        coords: [[[13.538879,52.660824], [13.528761,52.651814], [13.528686,52.607903], [13.556227,52.600220], [13.567675,52.595249], [13.609828,52.604977], [13.611888,52.605209], [13.619007,52.602798], [13.610666,52.578167], [13.630943,52.549007], [13.637037,52.544548], [13.657540,52.538101], [13.674932,52.519753], [13.677259,52.519157], [13.678188,52.497913], [13.697193,52.474037], [13.701946,52.471397], [13.723876,52.470173], [13.724541,52.470455], [13.727953,52.472115], [13.736600,52.478180], [13.754303,52.485054], [13.789726,52.492008], [13.794283,52.491585], [13.795264,52.491566], [13.797698,52.491100], [13.800973,52.468872], [13.800848,52.448315], [13.763696,52.431156], [13.755054,52.403126], [13.747533,52.385464], [13.709156,52.371998], [13.708781,52.371861], [13.701539,52.367859], [13.695094,52.362785], [13.682280,52.351803], [13.667335,52.340267], [13.638582,52.329674], [13.632638,52.318165], [13.632112,52.317753], [13.621459,52.304573], [13.620654,52.304005], [13.620579,52.303959], [13.620429,52.303909], [13.619538,52.303654], [13.610537,52.304234], [13.602683,52.316589], [13.580666,52.343945], [13.550090,52.356258], [13.538000,52.353165], [13.524166,52.355831], [13.519166,52.355331], [13.515071,52.360348], [13.489151,52.369152], [13.487777,52.369732], [13.475900,52.383850], [13.454220,52.386909], [13.446407,52.386078], [13.427610,52.374313], [13.404784,52.354927], [13.365640,52.343204], [13.377571,52.365589], [13.372893,52.385738], [13.360962,52.397404], [13.351530,52.401371], [13.328282,52.405457], [13.305919,52.404751], [13.305632,52.404602], [13.282892,52.407562], [13.280276,52.406612], [13.280039,52.406513], [13.275711,52.404282], [13.264210,52.401581], [13.253931,52.395008], [13.220672,52.370358], [13.215866,52.372036], [13.183851,52.388592], [13.181989,52.388844], [13.174624,52.388985], [13.172977,52.388760], [13.138790,52.372009], [13.130893,52.369495], [13.112568,52.367203], [13.104243,52.371971], [13.094179,52.375401], [13.067593,52.376907], [13.063387,52.374393], [13.038969,52.370777], [13.029870,52.383404], [13.031630,52.388748], [13.032531,52.396240], [13.034382,52.400997], [13.035557,52.402836], [13.036643,52.403927], [13.038100,52.405437], [13.049740,52.412811], [13.054665,52.447803], [13.084630,52.465424], [13.117589,52.476246], [13.121538,52.494434], [13.113727,52.519196], [13.082013,52.532356], [13.117611,52.552353], [13.128161,52.556000], [13.140951,52.590031], [13.144969,52.592724], [13.153976,52.595734], [13.165998,52.594212], [13.187241,52.609940], [13.188571,52.613159], [13.191318,52.614616], [13.206939,52.618683], [13.213866,52.622028], [13.226101,52.646370], [13.257167,52.653000], [13.263566,52.676647], [13.278800,52.690102], [13.281537,52.692036], [13.288135,52.693539], [13.294830,52.695087], [13.302329,52.691307], [13.334484,52.685955], [13.363494,52.672737], [13.403835,52.644314], [13.430271,52.654205], [13.443920,52.659866], [13.474087,52.686737], [13.514814,52.689701], [13.525666,52.687332], [13.543395,52.679558], [13.560444,52.668602], [13.580764,52.665829], [13.576043,52.661709], [13.574423,52.661583], [13.573780,52.661785], [13.570464,52.664227], [13.538879,52.660824]]]
                    },
                    Birmingham: {
                        lat: 52.483056,
                        lng: -1.893611,
                        population: 1092330, // 2013 - http://www.neighbourhood.statistics.gov.uk/HTMLDocs/dvc134_a/index.html
                        area: 267.77,
                        coords: [[[-1.947262, 52.513363], [-1.932220, 52.526665], [-1.919564, 52.524940], [-1.916681, 52.525848], [-1.904840, 52.530609], [-1.902480, 52.532253], [-1.903595, 52.553902], [-1.899325, 52.533592], [-1.879734, 52.539360], [-1.867675, 52.556316], [-1.845445, 52.558193], [-1.845467, 52.538158], [-1.837100, 52.533741], [-1.819782, 52.532879], [-1.819667, 52.532833], [-1.813774, 52.531574], [-1.812400, 52.531315], [-1.810984, 52.531025], [-1.806564, 52.530426], [-1.797552, 52.528351], [-1.796607, 52.528233], [-1.794891, 52.528179], [-1.791779, 52.527828], [-1.782885, 52.530777], [-1.780353, 52.531433], [-1.778154, 52.530895], [-1.772262, 52.529099], [-1.772006, 52.528996], [-1.761760, 52.528336], [-1.749702, 52.532089], [-1.741504, 52.535461], [-1.739015, 52.536701], [-1.737927, 52.536686], [-1.722353, 52.545998], [-1.734353, 52.528862], [-1.727342, 52.515804], [-1.748242, 52.504047], [-1.730346, 52.490517], [-1.723823, 52.469604], [-1.718158, 52.455173], [-1.717149, 52.453232], [-1.715729, 52.450409], [-1.716613, 52.448059], [-1.724767, 52.450333], [-1.730620, 52.450409], [-1.748585, 52.454102], [-1.762619, 52.466743], [-1.775493, 52.457733], [-1.782574, 52.452347], [-1.791980, 52.449905], [-1.795921, 52.446514], [-1.801618, 52.443321], [-1.807270, 52.442932], [-1.816177, 52.438538], [-1.824009, 52.430267], [-1.833686, 52.419800], [-1.844823, 52.403599], [-1.849479, 52.399933], [-1.862869, 52.399643], [-1.869349, 52.393280], [-1.863212, 52.367424], [-1.872420, 52.391369], [-1.887159, 52.384190], [-1.892995, 52.370239], [-1.893489, 52.369873], [-1.918466, 52.364685], [-1.921234, 52.362888], [-1.931500, 52.362000], [-1.945075, 52.361740], [-1.947498, 52.364594], [-1.958087, 52.370747], [-1.971273, 52.381207], [-1.987538, 52.383385], [-1.994662, 52.387569], [-1.995649, 52.387951], [-2.020454, 52.392769], [-2.029166, 52.416988], [-2.032642, 52.430111], [-2.032384, 52.432835], [-2.027334, 52.445332], [-2.028706, 52.449993], [-2.023333, 52.452831], [-2.017707, 52.456100], [-2.014017, 52.458729], [-2.011173, 52.461411], [-2.007880, 52.461735], [-1.999887, 52.466373], [-1.990834, 52.468498], [-1.987323, 52.471123], [-1.985371, 52.473251], [-1.981379, 52.483158], [-1.967754, 52.487377], [-1.966445, 52.505772], [-1.965909, 52.505997], [-1.947466, 52.513313], [-1.947348, 52.513348], [-1.947262, 52.513363]]]
                    },
                    Brussels: {
                        lat: 50.85,
                        lng: 4.35,
                        population: 1138854, // 2013 - http://statbel.fgov.be/nl/binaries/pop2010-2013mov_nl_tcm325-234223.xls
                        area: 161.38,
                        coords:[[[4.522880,50.826954], [4.520552,50.826317], [4.519983,50.826115], [4.519114,50.825890], [4.516925,50.826839], [4.513911,50.827652], [4.502881,50.829693], [4.487485,50.819412], [4.483812,50.817425], [4.483597,50.817329], [4.475555,50.811249], [4.470062,50.802898], [4.469364,50.799313], [4.459762,50.789783], [4.452516,50.781807], [4.446630,50.767071], [4.444516,50.767929], [4.431438,50.767162], [4.425601,50.755356], [4.421954,50.763432], [4.414443,50.766972], [4.409637,50.770988], [4.396762,50.773380], [4.391784,50.777287], [4.373974,50.771961], [4.357600,50.772400], [4.353976,50.768074], [4.347646,50.764713], [4.340500,50.762691], [4.339191,50.762589], [4.330458,50.763054], [4.325833,50.780334], [4.318303,50.785320], [4.313604,50.787800], [4.303593,50.792088], [4.301844,50.792324], [4.282264,50.791828], [4.271458,50.810787], [4.263381,50.812279], [4.247417,50.811031], [4.241666,50.821308], [4.241892,50.838902], [4.255636,50.845314], [4.255865,50.845371], [4.262738,50.845268], [4.263000,50.845200], [4.266445,50.841572], [4.283959,50.836365], [4.287438,50.838684], [4.292757,50.857132], [4.287174,50.865067], [4.288101,50.871246], [4.288830,50.872765], [4.289860,50.873623], [4.294881,50.882946], [4.294795,50.889771], [4.300666,50.896507], [4.306662,50.902615], [4.311446,50.901447], [4.317674,50.901733], [4.327000,50.902500], [4.338334,50.910568], [4.339599,50.934200], [4.328613,50.934200], [4.339599,50.942852], [4.356079,50.934200], [4.367065,50.937660], [4.372558,50.922081], [4.384145,50.918510], [4.390000,50.919998], [4.394084,50.923573], [4.400156,50.927135], [4.410000,50.930000], [4.411666,50.930000], [4.425859,50.926922], [4.434871,50.925327], [4.422340,50.917728], [4.425127,50.903046], [4.428044,50.897106], [4.429206,50.895237], [4.432296,50.878479], [4.441008,50.875122], [4.447753,50.876968], [4.454022,50.885426], [4.461522,50.894344], [4.470748,50.894371], [4.477164,50.896835], [4.481391,50.900108], [4.482378,50.900703], [4.486112,50.901897], [4.487915,50.902164], [4.489889,50.899460], [4.497570,50.893261], [4.506272,50.889492], [4.507226,50.889351], [4.508010,50.889275], [4.517269,50.886520], [4.530143,50.880402], [4.539070,50.886963], [4.547535,50.888916], [4.551687,50.889282], [4.562201,50.885513], [4.575033,50.891068], [4.583176,50.880875], [4.579710,50.878128], [4.575290,50.869568], [4.573638,50.846123], [4.567930,50.867916], [4.554519,50.869408], [4.535207,50.875526], [4.533094,50.873653], [4.519801,50.868324], [4.526474,50.847900], [4.523752,50.832523], [4.524908,50.829197], [4.524800,50.828304], [4.524307,50.827843], [4.522880,50.826954]]]
                    },
                    Delhi: { // This is the municipality rather than New Delhi
                        lat: 28.61,
                        lng: 77.23,
                        population: 11007835, // 2011 - http://censusindia.gov.in/2011-prov-results/paper2/data_files/India2/Table_2_PR_Cities_1Lakh_and_Above.pdf
                        area: 46208,
                        coords: [[[76.395851,27.307949], [76.357231,27.317249], [76.379036,27.330482], [76.695557,28.167059], [76.707779,28.822296], [76.816406,28.883160], [76.926270,28.902397], [77.167969,28.998531], [77.739258,28.998531], [78.145752,28.755619], [78.148499,28.744783], [78.072624,28.327805], [77.651367,27.498526], [78.041916,27.175438], [78.052368,27.170055], [78.050079,27.168465], [77.668533,27.087326], [77.664497,27.085875], [77.501869,27.209930], [77.151489,28.057438], [76.449585,27.301451], [76.395851,27.307949]]]
                    },
                    Leeds: {
                        lat: 53.799722,
                        lng: -1.549167,
                        population: 761481, // 2013 - http://www.neighbourhood.statistics.gov.uk/HTMLDocs/dvc134_a/index.html
                        area: 487.8,
                        coords: [[[-1.679592,53.868748], [-1.679499,53.868786], [-1.671681,53.873081], [-1.663827,53.893867], [-1.661167,53.898624], [-1.631298,53.901859], [-1.601943,53.907524], [-1.599798,53.904388], [-1.591987,53.890228], [-1.562483,53.892429], [-1.556410,53.896271], [-1.549544,53.911568], [-1.530704,53.900597], [-1.518173,53.905552], [-1.512658,53.901043], [-1.501007,53.891594], [-1.490621,53.877541], [-1.490235,53.877327], [-1.483568,53.854542], [-1.483541,53.854519], [-1.479506,53.851753], [-1.449154,53.870426], [-1.432265,53.889977], [-1.443157,53.865639], [-1.442127,53.862461], [-1.433930,53.850353], [-1.416334,53.841999], [-1.421435,53.828255], [-1.400434,53.802120], [-1.392452,53.803513], [-1.389727,53.803944], [-1.388804,53.804150], [-1.373720,53.822697], [-1.377067,53.806732], [-1.381060,53.791840], [-1.389598,53.788456], [-1.397978,53.788055], [-1.411871,53.774361], [-1.422799,53.772221], [-1.431097,53.778137], [-1.460494,53.760281], [-1.479077,53.747341], [-1.491136,53.753571], [-1.507841,53.748016], [-1.510523,53.748344], [-1.529331,53.740208], [-1.533966,53.726982], [-1.537699,53.725510], [-1.564667,53.727001], [-1.568024,53.727928], [-1.581516,53.729153], [-1.589841,53.738411], [-1.601815,53.749687], [-1.626663,53.750069], [-1.630611,53.760891], [-1.632167,53.766666], [-1.636447,53.774181], [-1.637263,53.797749], [-1.646919,53.807899], [-1.671166,53.807549], [-1.673153,53.808208], [-1.676359,53.811256], [-1.671742,53.815388], [-1.671700,53.815414], [-1.671651,53.815437], [-1.668612,53.817097], [-1.667647,53.853195], [-1.679835,53.860798], [-1.681951,53.865540], [-1.682501,53.866383], [-1.679592,53.868748]]]
                    },
                    Lisbon: {
                        lat: 38.713889,
                        lng: -9.139444,
                        population: 552700, // 2011 - census
                        area: 100.05,
                        coords: [[[-9.049869,38.767448], [-9.048786,38.766731], [-9.063034,38.749531], [-9.057025,38.772320], [-9.059944,38.773827], [-9.062819,38.776501], [-9.078762,38.776154], [-9.085521,38.763653], [-9.084792,38.742935], [-9.077796,38.725964], [-9.083290,38.727840], [-9.092559,38.728642], [-9.105606,38.720341], [-9.107322,38.719002], [-9.116592,38.698772], [-9.107666,38.691406], [-9.118652,38.696095], [-9.138178,38.696964], [-9.145474,38.695492], [-9.162769,38.680618], [-9.163842,38.677551], [-9.175472,38.665543], [-9.178304,38.663597], [-9.178873,38.669350], [-9.184398,38.683968], [-9.188432,38.685745], [-9.190406,38.687786], [-9.203796,38.693279], [-9.206199,38.695557], [-9.206371,38.700314], [-9.208023,38.704857], [-9.212636,38.713509], [-9.230747,38.725925], [-9.238654,38.727547], [-9.225361,38.738930], [-9.225189,38.740108], [-9.219331,38.746319], [-9.219160,38.758568], [-9.219675,38.765511], [-9.221434,38.769108], [-9.219506,38.777519], [-9.197273,38.778442], [-9.192187,38.782707], [-9.188110,38.790241], [-9.181544,38.794281], [-9.181019,38.794239], [-9.167146,38.812042], [-9.157962,38.815502], [-9.142777,38.825275], [-9.156219,38.810116], [-9.147952,38.799637], [-9.140110,38.782391], [-9.129638,38.774895], [-9.106121,38.768757], [-9.097881,38.776436], [-9.094276,38.789616], [-9.090199,38.786369], [-9.068784,38.781052], [-9.066123,38.779514], [-9.063205,38.777306], [-9.058238,38.773643], [-9.052906,38.769943], [-9.051318,38.768505], [-9.049869,38.767448]]]
                    },
                    Liverpool: {
                        lat: 53.4,
                        lng: -2.983333,
                        population: 470780, // 2013 - http://www.neighbourhood.statistics.gov.uk/HTMLDocs/dvc134_a/index.html
                        area: 111.84,
                        coords: [[[-2.937469,53.469120], [-2.932834,53.473053], [-2.932105,53.473827], [-2.928757,53.477013], [-2.927995,53.476501], [-2.915309,53.469090], [-2.912833,53.468834], [-2.907000,53.468498], [-2.892494,53.464260], [-2.889232,53.463577], [-2.879347,53.454990], [-2.861166,53.459717], [-2.860779,53.459896], [-2.859277,53.459385], [-2.849364,53.451336], [-2.848978,53.451286], [-2.834472,53.461479], [-2.827305,53.444359], [-2.817209,53.437103], [-2.816138,53.436874], [-2.815965,53.436813], [-2.798767,53.451260], [-2.808380,53.428776], [-2.797071,53.420135], [-2.785549,53.420940], [-2.797189,53.415203], [-2.787780,53.395615], [-2.800237,53.384949], [-2.803916,53.380871], [-2.817478,53.374111], [-2.817398,53.355686], [-2.813487,53.352505], [-2.814903,53.351475], [-2.820070,53.346561], [-2.823185,53.335510], [-2.824602,53.332848], [-2.830288,53.330418], [-2.830717,53.330524], [-2.836500,53.332333], [-2.852969,53.333809], [-2.860565,53.334717], [-2.870006,53.336819], [-2.875859,53.334114], [-2.879759,53.332424], [-2.882623,53.334309], [-2.889232,53.338612], [-2.891120,53.339508], [-2.895390,53.341499], [-2.898706,53.342281], [-2.905969,53.347553], [-2.915233,53.353607], [-2.918500,53.353909], [-2.927684,53.354343], [-2.936954,53.349319], [-2.951030,53.356598], [-2.967315,53.355961], [-2.967572,53.356194], [-2.984024,53.368835], [-2.992229,53.362152], [-2.993461,53.368439], [-3.002014,53.380051], [-3.010597,53.388447], [-3.019866,53.392746], [-3.020210,53.396126], [-3.035960,53.407150], [-3.023643,53.410862], [-3.020896,53.415977], [-3.017120,53.425900], [-3.021841,53.443146], [-3.029994,53.448959], [-3.034286,53.454887], [-3.048599,53.458885], [-3.063812,53.445126], [-3.071365,53.466896], [-3.079685,53.481548], [-3.080828,53.487606], [-3.073532,53.495342], [-3.071236,53.497097], [-3.065717,53.507500], [-3.070195,53.518040], [-3.063865,53.518055], [-3.055143,53.511990], [-3.042846,53.502991], [-3.029179,53.506374], [-3.027731,53.507843], [-3.010098,53.511478], [-3.001606,53.514381], [-2.997293,53.505123], [-2.994257,53.502056], [-2.993763,53.501465], [-2.984333,53.495754], [-2.971637,53.503998], [-2.959425,53.508553], [-2.949893,53.523842], [-2.958084,53.529186], [-2.959425,53.508553], [-2.973947,53.495857], [-2.972536,53.487957], [-2.969462,53.482868], [-2.956180,53.472466], [-2.948284,53.468227], [-2.937469,53.469120]]]
                    },
                    London: {
                        lat: 51.5,
                        lng: -0.116667,
                        population: 8416535, // 2013 - http://www.neighbourhood.statistics.gov.uk/HTMLDocs/dvc134_a/index.html
                        area: 1572,
                        coords: [[[-0.404841,51.425877], [-0.404906,51.425934], [-0.420227,51.431858], [-0.428466,51.432930], [-0.449066,51.435284], [-0.452928,51.439137], [-0.454108,51.442131], [-0.454516,51.442852], [-0.454817,51.444614], [-0.454645,51.447159], [-0.466060,51.460812], [-0.467262,51.462029], [-0.478634,51.466412], [-0.483398,51.467697], [-0.493698,51.465973], [-0.503319,51.472919], [-0.505456,51.473309], [-0.515542,51.477669], [-0.510950,51.485512], [-0.505735,51.486759], [-0.498874,51.504269], [-0.501630,51.508358], [-0.506401,51.518463], [-0.519275,51.522362], [-0.517730,51.529251], [-0.500556,51.535831], [-0.500426,51.536156], [-0.491402,51.539642], [-0.488891,51.554020], [-0.496482,51.565647], [-0.497474,51.567360], [-0.501873,51.572041], [-0.519833,51.576057], [-0.523223,51.590080], [-0.511030,51.597630], [-0.511765,51.612526], [-0.498923,51.621933], [-0.497270,51.623943], [-0.491638,51.632748], [-0.490221,51.637238], [-0.485072,51.638874], [-0.471253,51.639050], [-0.468389,51.637363], [-0.467562,51.637051], [-0.461286,51.635006], [-0.459516,51.633453], [-0.448207,51.628262], [-0.432672,51.629845], [-0.432281,51.629944], [-0.429880,51.630196], [-0.428300,51.630348], [-0.423741,51.630806], [-0.410270,51.630882], [-0.404769,51.611919], [-0.397557,51.611542], [-0.390958,51.614658], [-0.389456,51.615044], [-0.378642,51.617668], [-0.371432,51.622093], [-0.357999,51.621685], [-0.356411,51.622826], [-0.355682,51.623211], [-0.353858,51.623806], [-0.343580,51.635334], [-0.342979,51.639942], [-0.344217,51.645000], [-0.344215,51.645004], [-0.323984,51.654373], [-0.318818,51.652802], [-0.309741,51.648994], [-0.302982,51.649529], [-0.299549,51.649220], [-0.292897,51.649174], [-0.280344,51.653214], [-0.275870,51.661297], [-0.272663,51.666737], [-0.253500,51.677166], [-0.253334,51.677166], [-0.253167,51.676998], [-0.242128,51.670746], [-0.228667,51.685165], [-0.224000,51.686668], [-0.223667,51.686832], [-0.223500,51.686832], [-0.223333,51.686832], [-0.223000,51.686832], [-0.222833,51.686832], [-0.219744,51.684216], [-0.214254,51.678352], [-0.196509,51.677822], [-0.194631,51.678276], [-0.194063,51.678223], [-0.188097,51.678913], [-0.177583,51.677559], [-0.176296,51.677345], [-0.165331,51.680870], [-0.148658,51.686283], [-0.140210,51.687279], [-0.132007,51.703190], [-0.116729,51.708389], [-0.110060,51.720230], [-0.092010,51.710545], [-0.085401,51.710770], [-0.074157,51.707298], [-0.063514,51.696739], [-0.056519,51.689796], [-0.053551,51.687191], [-0.046037,51.684738], [-0.039138,51.683704], [-0.030620,51.685528], [-0.014333,51.695225], [0.001628,51.685284], [-0.000987,51.673939], [0.009613,51.657330], [0.023517,51.660099], [0.043022,51.651924], [0.033666,51.644165], [0.031166,51.632000], [0.043720,51.617062], [0.064931,51.625851], [0.064974,51.626011], [0.065188,51.625908], [0.080198,51.624542], [0.092401,51.614723], [0.101730,51.612587], [0.111794,51.616337], [0.116965,51.611721], [0.135054,51.617138], [0.137844,51.614819], [0.157595,51.605663], [0.162413,51.610912], [0.164408,51.615032], [0.171192,51.627796], [0.184965,51.643375], [0.190715,51.645847], [0.211466,51.637859], [0.228309,51.630470], [0.238658,51.634148], [0.242900,51.633961], [0.256140,51.629658], [0.264701,51.628033], [0.267072,51.628216], [0.270023,51.624958], [0.275833,51.613609], [0.291942,51.601219], [0.291996,51.601208], [0.297950,51.599983], [0.308475,51.593235], [0.328731,51.581867], [0.336112,51.576641], [0.328044,51.569386], [0.325469,51.567039], [0.322798,51.564075], [0.306072,51.566452], [0.295236,51.549675], [0.312252,51.542759], [0.304527,51.541290], [0.298519,51.541771], [0.289378,51.542027], [0.287210,51.541077], [0.280086,51.533577], [0.273284,51.532776], [0.261193,51.520176], [0.255517,51.519478], [0.243587,51.522842], [0.239295,51.522808], [0.226206,51.503052], [0.228333,51.500668], [0.228910,51.500141], [0.229666,51.499001], [0.235333,51.493168], [0.235502,51.484386], [0.234575,51.471146], [0.216207,51.470379], [0.213546,51.468178], [0.207624,51.461655], [0.205307,51.454861], [0.195641,51.453259], [0.191144,51.448952], [0.190962,51.448750], [0.180104,51.445183], [0.174429,51.437725], [0.172991,51.435349], [0.151662,51.429611], [0.146341,51.416340], [0.150632,51.408466], [0.168310,51.401161], [0.169794,51.401802], [0.170159,51.401600], [0.172519,51.399075], [0.171575,51.397800], [0.169429,51.396233], [0.165320,51.391876], [0.161583,51.383568], [0.172833,51.367332], [0.184106,51.371323], [0.185737,51.370922], [0.188076,51.370159], [0.188527,51.369957], [0.182991,51.354736], [0.181617,51.352863], [0.179557,51.345947], [0.173163,51.336571], [0.172605,51.334755], [0.172563,51.334755], [0.159166,51.322834], [0.159000,51.321167], [0.158000,51.320000], [0.153293,51.328251], [0.133300,51.330101], [0.119250,51.326866], [0.108296,51.333157], [0.099483,51.344666], [0.082054,51.328037], [0.080444,51.309559], [0.080831,51.308590], [0.080809,51.307487], [0.082697,51.292198], [0.071411,51.288548], [0.061111,51.287903], [0.050125,51.285164], [0.030555,51.289230], [0.018453,51.283554], [0.014162,51.278660], [0.005664,51.278774], [-0.007596,51.286160], [-0.001364,51.289406], [0.006072,51.302273], [0.004677,51.315189], [-0.009953,51.323799], [-0.016197,51.332451], [-0.020119,51.333977], [-0.033431,51.332958], [-0.044159,51.327366], [-0.060446,51.330479], [-0.066561,51.329594], [-0.081882,51.316879], [-0.079822,51.309837], [-0.078706,51.299122], [-0.073127,51.292305], [-0.089778,51.289619], [-0.095082,51.290619], [-0.101484,51.291401], [-0.102220,51.291389], [-0.106472,51.291115], [-0.119304,51.292171], [-0.120077,51.292171], [-0.120677,51.292423], [-0.123853,51.293392], [-0.130151,51.293068], [-0.139303,51.281086], [-0.140419,51.281094], [-0.152091,51.289082], [-0.152834,51.292831], [-0.152177,51.296169], [-0.150290,51.301811], [-0.155019,51.313969], [-0.153431,51.322201], [-0.160476,51.332100], [-0.171318,51.332329], [-0.179500,51.335999], [-0.192893,51.333523], [-0.200554,51.321739], [-0.210070,51.331474], [-0.211315,51.333775], [-0.213203,51.337597], [-0.214158,51.343929], [-0.229146,51.352932], [-0.237291,51.335171], [-0.233974,51.355274], [-0.252685,51.367493], [-0.263671,51.371780], [-0.266247,51.372154], [-0.273284,51.371780], [-0.287103,51.371834], [-0.287275,51.371727], [-0.292823,51.363850], [-0.297660,51.353935], [-0.296974,51.346161], [-0.298293,51.338943], [-0.298288,51.338017], [-0.298293,51.337852], [-0.301694,51.327984], [-0.311479,51.326267], [-0.315299,51.322765], [-0.331478,51.316559], [-0.337743,51.316292], [-0.353364,51.311462], [-0.359834,51.313000], [-0.355403,51.328346], [-0.348987,51.324066], [-0.330666,51.329498], [-0.325706,51.347691], [-0.319461,51.355152], [-0.321049,51.365997], [-0.321178,51.369156], [-0.316586,51.373680], [-0.321918,51.391167], [-0.327186,51.392338], [-0.327841,51.392483], [-0.334337,51.392296], [-0.335673,51.392155], [-0.336500,51.391998], [-0.338752,51.395157], [-0.341713,51.397774], [-0.351562,51.399204], [-0.370200,51.404800], [-0.375144,51.407200], [-0.379639,51.407459], [-0.395507,51.399204], [-0.398383,51.416901], [-0.400167,51.419167], [-0.404841,51.425877]]]
                    },
                    Madrid: {
                        lat: 40.383333,
                        lng: -3.716667,
                        population: 3165235, // 2014 - http://en.wikipedia.org/wiki/Madrid
                        area: 605.77,
                        coords: [[[-3.721951,40.323425], [-3.727240,40.323055], [-3.735222,40.319767], [-3.759019,40.329323], [-3.765950,40.325542], [-3.775016,40.320145], [-3.787708,40.318737], [-3.797664,40.323776], [-3.803243,40.325985], [-3.806784,40.328182], [-3.819808,40.340328], [-3.839893,40.342342], [-3.844742,40.349667], [-3.843541,40.350502], [-3.837833,40.353184], [-3.831535,40.358513], [-3.832222,40.390091], [-3.835333,40.426491], [-3.836717,40.428265], [-3.846448,40.441360], [-3.853572,40.445694], [-3.876671,40.442661], [-3.880920,40.439110], [-3.878388,40.458931], [-3.878399,40.459064], [-3.882197,40.474609], [-3.893923,40.484055], [-3.887507,40.487000], [-3.871800,40.510029], [-3.852158,40.497238], [-3.832941,40.499802], [-3.812170,40.504482], [-3.787193,40.497272], [-3.768860,40.507275], [-3.749122,40.511589], [-3.745393,40.511776], [-3.740437,40.513123], [-3.725566,40.527760], [-3.716458,40.526955], [-3.698616,40.547894], [-3.690268,40.552174], [-3.662395,40.551571], [-3.653866,40.554317], [-3.641222,40.558262], [-3.635900,40.563519], [-3.612442,40.544590], [-3.610746,40.543213], [-3.599167,40.525665], [-3.578281,40.526947], [-3.558712,40.531872], [-3.545150,40.537025], [-3.534164,40.528416], [-3.531417,40.527370], [-3.533070,40.508892], [-3.532973,40.504604], [-3.530988,40.471043], [-3.527126,40.468990], [-3.518028,40.467388], [-3.498973,40.457878], [-3.477923,40.445484], [-3.469855,40.447353], [-3.480134,40.437115], [-3.491077,40.422676], [-3.491592,40.421730], [-3.506183,40.410629], [-3.507835,40.398113], [-3.508318,40.398029], [-3.516258,40.394733], [-3.531289,40.381771], [-3.537410,40.366192], [-3.542747,40.358643], [-3.542779,40.358578], [-3.547360,40.356174], [-3.571243,40.358055], [-3.586091,40.346149], [-3.589954,40.334064], [-3.615049,40.357681], [-3.635015,40.352791], [-3.639907,40.351517], [-3.654820,40.339706], [-3.656434,40.324913], [-3.687458,40.327114], [-3.695560,40.325089], [-3.713335,40.323170], [-3.721951,40.323425]]]
                    },
                    Manchester: {
                        lat: 53.466667,
                        lng: -2.233333,
                        population: 514417, // 2013 - http://www.neighbourhood.statistics.gov.uk/HTMLDocs/dvc134_a/index.html
                        area: 115.65,
                        coords: [[[-2.285334,53.556831], [-2.269419,53.554478], [-2.253167,53.563168], [-2.236318,53.567024], [-2.227220,53.570133], [-2.222268,53.571129], [-2.217607,53.570999], [-2.209281,53.564388], [-2.192373,53.554333], [-2.183908,53.551788], [-2.174531,53.551220], [-2.172256,53.548393], [-2.170937,53.540474], [-2.157526,53.521763], [-2.125403,53.507130], [-2.107486,53.518112], [-2.121734,53.503696], [-2.121434,53.483768], [-2.125275,53.477005], [-2.128815,53.458576], [-2.106542,53.439373], [-2.130049,53.439610], [-2.132742,53.438602], [-2.138042,53.437328], [-2.149994,53.429276], [-2.154972,53.426685], [-2.183918,53.436012], [-2.187130,53.435555], [-2.201833,53.428211], [-2.204078,53.425537], [-2.211577,53.407742], [-2.216105,53.400681], [-2.219238,53.399708], [-2.241125,53.375675], [-2.216835,53.354626], [-2.248806,53.345852], [-2.250437,53.325798], [-2.277083,53.343170], [-2.296271,53.336151], [-2.297301,53.336205], [-2.301979,53.336254], [-2.332717,53.327564], [-2.319660,53.355621], [-2.316222,53.390408], [-2.327084,53.395306], [-2.319531,53.397148], [-2.313589,53.401321], [-2.315540,53.435207], [-2.325453,53.439198], [-2.326816,53.439789], [-2.331912,53.442478], [-2.355537,53.435871], [-2.374437,53.467384], [-2.376651,53.466846], [-2.381629,53.464546], [-2.384376,53.463676], [-2.395062,53.463436], [-2.414031,53.456627], [-2.425403,53.463730], [-2.434716,53.472313], [-2.444071,53.501801], [-2.446184,53.507095], [-2.437591,53.515640], [-2.434329,53.533268], [-2.420908,53.537964], [-2.410082,53.538670], [-2.393689,53.530830], [-2.390320,53.531059], [-2.375450,53.530411], [-2.367477,53.535980], [-2.357082,53.537121], [-2.354207,53.537399], [-2.331129,53.552151], [-2.330517,53.556587], [-2.330818,53.563629], [-2.328543,53.565624], [-2.325540,53.565727], [-2.321805,53.565548], [-2.308169,53.564781], [-2.289173,53.560066], [-2.285334,53.556831]]]
                    },
                    'Mexico City': {
                        lat: 19.433333,
                        lng: -99.133333,
                        population: 8851080, // 2010 - https://en.wikipedia.org/wiki/Mexico_City
                        area: 1485,
                        coords: [[[-99.066551,19.478750], [-99.061485,19.468685], [-99.055534,19.453341], [-99.052002,19.445095], [-99.052177,19.440006], [-99.052101,19.436350], [-99.037628,19.411716], [-99.022736,19.385885], [-99.009842,19.370152], [-98.998299,19.364920], [-98.993958,19.360142], [-98.975784,19.338903], [-98.963470,19.322321], [-98.960548,19.319891], [-98.985016,19.294172], [-98.978996,19.261833], [-98.978577,19.251514], [-98.961853,19.225309], [-98.962204,19.223627], [-98.929619,19.186424], [-98.984596,19.184834], [-98.990250,19.161547], [-98.999680,19.169174], [-98.999977,19.169363], [-99.030418,19.176140], [-99.073036,19.185320], [-99.091827,19.183638], [-99.101669,19.192165], [-99.147835,19.200457], [-99.156837,19.185833], [-99.156761,19.156761], [-99.160538,19.149628], [-99.196930,19.166573], [-99.212036,19.163328], [-99.232880,19.196247], [-99.231003,19.234167], [-99.242935,19.243250], [-99.251183,19.250673], [-99.265701,19.286354], [-99.281555,19.295103], [-99.316574,19.306622], [-99.348763,19.297041], [-99.352371,19.296703], [-99.356743,19.298264], [-99.357864,19.298588], [-99.347115,19.303818], [-99.336166,19.320873], [-99.331017,19.333708], [-99.306961,19.352285], [-99.301323,19.368214], [-99.291985,19.372278], [-99.272758,19.385082], [-99.265671,19.393419], [-99.257896,19.397682], [-99.245598,19.416735], [-99.229576,19.435879], [-99.225769,19.445873], [-99.235786,19.486620], [-99.207260,19.505304], [-99.192657,19.514511], [-99.207527,19.564320], [-99.178734,19.538113], [-99.146629,19.554291], [-99.132729,19.572245], [-99.132172,19.573921], [-99.111786,19.583080], [-99.097412,19.537102], [-99.095909,19.520964], [-99.071617,19.502842], [-99.066551,19.478750]]]
                    },
                    Mumbai: {
                        lat: 18.975,
                        lng: 72.825833,
                        population: 12478447, // 2011, http://www.censusindia.gov.in/2011-prov-results/paper2/data_files/India2/Table_2_PR_Cities_1Lakh_and_Above.pdf
                        area: 603,
                        coords: [[[72.930443,18.972458], [72.930702,18.972361], [72.934113,18.965389], [72.935486,18.960520], [72.927589,18.955811], [72.907333,18.956299], [72.902351,18.948668], [72.902054,18.940861], [72.903259,18.936529], [72.902008,18.936043], [72.887848,18.928127], [72.884155,18.926584], [72.871796,18.920860], [72.869995,18.920576], [72.857033,18.911158], [72.848160,18.910793], [72.843300,18.908236], [72.837807,18.898167], [72.840210,18.882330], [72.823563,18.901009], [72.816010,18.896887], [72.810516,18.885174], [72.799011,18.879002], [72.798370,18.879408], [72.800217,18.886992], [72.800903,18.897190], [72.801247,18.903362], [72.800903,18.905960], [72.800560,18.910995], [72.777725,18.920252], [72.792320,18.931456], [72.792297,18.939102], [72.770691,18.949154], [72.780304,18.956081], [72.791634,18.967501], [72.798157,18.984221], [72.800903,18.999241], [72.806396,19.004995], [72.810684,19.014410], [72.803009,19.027596], [72.795410,19.030964], [72.797470,19.040699], [72.808968,19.044594], [72.817513,19.056520], [72.817383,19.060007], [72.811890,19.069256], [72.806396,19.082884], [72.800003,19.100000], [72.789917,19.114029], [72.783218,19.138519], [72.786613,19.154066], [72.784126,19.160046], [72.786484,19.167667], [72.789917,19.176300], [72.785278,19.193163], [72.783737,19.204996], [72.780815,19.210426], [72.776222,19.218817], [72.776871,19.221308], [72.778931,19.232309], [72.776871,19.248922], [72.790840,19.257257], [72.806396,19.248922], [72.819702,19.250238], [72.826996,19.258644], [72.842102,19.269665], [72.865242,19.278273], [72.871689,19.254623], [72.872314,19.254108], [72.897034,19.250217], [72.887589,19.236198], [72.886818,19.228256], [72.891541,19.219992], [72.910248,19.210264], [72.918129,19.213329], [72.923103,19.211750], [72.911453,19.202888], [72.908577,19.195189], [72.910591,19.186758], [72.922607,19.177031], [72.937202,19.180901], [72.946472,19.194460], [72.950897,19.183643], [72.955826,19.180490], [72.962128,19.175318], [72.973938,19.171112], [72.963432,19.153847], [72.952652,19.144762], [72.945099,19.132195], [72.945786,19.124409], [72.949219,19.108191], [72.940804,19.096855], [72.958832,19.080612], [72.970329,19.062929], [72.981659,19.064550], [72.969299,19.048569], [72.951447,19.048632], [72.941238,19.051977], [72.934456,19.050112], [72.928139,19.042292], [72.925873,19.026094], [72.904411,19.017412], [72.904976,19.004824], [72.900124,19.001831], [72.888794,18.982271], [72.901497,18.973515], [72.903900,18.973425], [72.922699,18.979959], [72.930443,18.972458]]]
                    },
                    Osaka: {
                        lat: 34.693889,
                        lng: 135.502222,
                        population: 2666371, // 2012, 'designated city' - https://en.wikipedia.org/wiki/Osaka
                        area: 223,
                        coords: [[[135.490280,34.833038], [135.490311,34.833073], [135.493790,34.834660], [135.498505,34.837479], [135.526657,34.831276], [135.533218,34.836079], [135.554810,34.837337], [135.560562,34.835556], [135.583649,34.819721], [135.606308,34.798580], [135.613083,34.777229], [135.593262,34.768692], [135.586044,34.761215], [135.575821,34.737492], [135.585648,34.723343], [135.596741,34.719818], [135.620728,34.734840], [135.633347,34.713253], [135.626160,34.680302], [135.590851,34.686863], [135.591888,34.705563], [135.593567,34.712284], [135.633347,34.713253], [135.642700,34.705494], [135.655594,34.685097], [135.653915,34.683159], [135.650208,34.681789], [135.649185,34.681622], [135.648254,34.681473], [135.643967,34.680286], [135.640015,34.680134], [135.620728,34.660320], [135.606995,34.637726], [135.605026,34.614044], [135.617981,34.592518], [135.590485,34.606232], [135.574722,34.594074], [135.548279,34.588562], [135.535416,34.588703], [135.510834,34.590000], [135.503403,34.590260], [135.494431,34.594879], [135.485352,34.595852], [135.482285,34.596172], [135.481491,34.596336], [135.472000,34.601334], [135.447174,34.598595], [135.424347,34.610603], [135.402542,34.614281], [135.401794,34.614681], [135.374908,34.616257], [135.368042,34.639988], [135.375595,34.669571], [135.405472,34.695076], [135.376282,34.714523], [135.359802,34.719040], [135.361511,34.731174], [135.382050,34.738792], [135.380569,34.767986], [135.392502,34.790932], [135.424255,34.810844], [135.436707,34.814083], [135.447525,34.813240], [135.472412,34.802830], [135.490784,34.826202], [135.490280,34.833038]]] // Osaka-shi
                    },
                    Paris: {
                        lat: 48.8567,
                        lng: 2.3508,
                        population: 2241346, // 2014 - http://www.insee.fr/fr/themes/tableau.asp?reg_id=20&ref_id=poptc02101
                        area: 2844.8,
                        coords: [[[2.084377,48.891781], [2.084361,48.891792], [2.073326,48.899822], [2.080085,48.903618], [2.114696,48.939980], [2.120146,48.944603], [2.141894,48.990784], [2.146024,49.014454], [2.150573,49.023350], [2.195618,49.038490], [2.233443,49.064754], [2.236061,49.076706], [2.236104,49.074089], [2.292945,49.029701], [2.312471,49.039570], [2.327041,49.007698], [2.376737,48.997280], [2.382917,48.997002], [2.404493,48.984161], [2.424716,48.973003], [2.444972,48.971260], [2.452182,48.972527], [2.455615,48.967876], [2.499947,48.924473], [2.570650,48.931026], [2.607150,48.924637], [2.626140,48.914757], [2.684869,48.871220], [2.697679,48.878277], [2.698860,48.878490], [2.688453,48.868587], [2.675685,48.851669], [2.646911,48.840382], [2.639122,48.844044], [2.581830,48.807384], [2.592945,48.771549], [2.662982,48.746117], [2.680664,48.754490], [2.695180,48.761246], [2.689847,48.771900], [2.667789,48.763203], [2.592945,48.771549], [2.591378,48.714573], [2.662982,48.746117], [2.611141,48.695320], [2.610797,48.693398], [2.579362,48.684975], [2.565650,48.666817], [2.554557,48.661201], [2.539086,48.681412], [2.504603,48.696011], [2.500419,48.696823], [2.466387,48.686852], [2.424051,48.696285], [2.397894,48.687687], [2.375793,48.662849], [2.370617,48.661793], [2.354400,48.656471], [2.354228,48.656536], [2.344379,48.662735], [2.323715,48.671856], [2.274942,48.663914], [2.264889,48.655342], [2.246274,48.640594], [2.228400,48.643856], [2.168334,48.664326], [2.153461,48.647865], [2.131497,48.640938], [2.116241,48.669144], [2.106370,48.677277], [2.122399,48.686192], [2.143235,48.700790], [2.158727,48.729076], [2.167911,48.757236], [2.169156,48.759075], [2.151324,48.826515], [2.145509,48.845287], [2.142269,48.852699], [2.127796,48.868103], [2.100362,48.890511], [2.084377,48.891781]]]
                    },
                    Rome: {
                        lat: 41.9,
                        lng: 12.5,
                        population: 2870528, // 2014 - http://www.demo.istat.it/bilmens2014gen/query.php?lingua=ita&Rip=S3&Reg=R12&Pro=P058&Com=91&submit=Tavola
                        area: 1285,
                        coords: [[[12.343873,41.700119], [12.338461,41.703213], [12.315888,41.708866], [12.272586,41.701180], [12.237567,41.705406], [12.162809,41.679321], [12.221603,41.726486], [12.223062,41.744514], [12.218599,41.771832], [12.222805,41.775791], [12.246494,41.799599], [12.267186,41.806671], [12.292499,41.837212], [12.257823,41.902531], [12.255442,41.906635], [12.248747,41.971966], [12.257480,41.976688], [12.273616,41.981377], [12.300031,42.024727], [12.293175,42.067413], [12.296683,42.074478], [12.310996,42.105961], [12.311553,42.114525], [12.315416,42.121273], [12.321853,42.119999], [12.325286,42.112423], [12.334668,42.072918], [12.367258,42.044353], [12.396783,42.043556], [12.410602,42.040115], [12.434506,41.980518], [12.485184,41.994514], [12.494716,42.016270], [12.506217,42.036289], [12.569732,42.050312], [12.568788,42.046967], [12.568209,42.001625], [12.605620,41.968494], [12.627426,41.958679], [12.656764,41.919266], [12.698888,41.925835], [12.706160,41.929245], [12.762272,41.922062], [12.786927,41.916328], [12.828168,41.932037], [12.826076,41.924217], [12.807387,41.901077], [12.784475,41.891140], [12.714067,41.886513], [12.677536,41.863186], [12.664897,41.830799], [12.628784,41.826500], [12.612991,41.825954], [12.570290,41.814091], [12.555828,41.785648], [12.562994,41.735870], [12.505541,41.729107], [12.441844,41.710846], [12.408027,41.662395], [12.407308,41.662384], [12.404841,41.663342], [12.402191,41.664703], [12.382450,41.676693], [12.374639,41.684193], [12.352924,41.696819], [12.343873,41.700119]]]
                    },
                    'São Paulo': {
                        lat: -23.55,
                        lng: -46.633333,
                        population: 11895893, // 2014 - ftp://ftp.ibge.gov.br/Estimativas_de_Populacao/Estimativas_2014/estimativa_dou_2014.pdf
                        area: 7943.82,
                        coords: [[[-46.532978,-23.446926], [-46.524696,-23.438601], [-46.515472,-23.443167], [-46.507771,-23.443979], [-46.501694,-23.446869], [-46.492596,-23.448757], [-46.478176,-23.444979], [-46.465385,-23.451475], [-46.463375,-23.471779], [-46.445652,-23.479694], [-46.421719,-23.475311], [-46.412601,-23.454979], [-46.434917,-23.439781], [-46.433800,-23.428677], [-46.404453,-23.433697], [-46.396122,-23.430252], [-46.394630,-23.433241], [-46.394581,-23.433378], [-46.394707,-23.433605], [-46.395542,-23.453571], [-46.381229,-23.477358], [-46.366318,-23.479149], [-46.354923,-23.466394], [-46.350368,-23.464205], [-46.345642,-23.480282], [-46.344002,-23.490496], [-46.346561,-23.491583], [-46.356236,-23.482450], [-46.373619,-23.481319], [-46.381809,-23.491095], [-46.384277,-23.497856], [-46.377411,-23.512997], [-46.388954,-23.521732], [-46.394405,-23.536133], [-46.389084,-23.562256], [-46.397968,-23.586821], [-46.389084,-23.596788], [-46.393719,-23.621052], [-46.417397,-23.614344], [-46.421581,-23.616283], [-46.434231,-23.605431], [-46.456032,-23.619833], [-46.459122,-23.628798], [-46.461525,-23.652149], [-46.450882,-23.663315], [-46.454895,-23.670078], [-46.459240,-23.669062], [-46.476490,-23.664877], [-46.484184,-23.639177], [-46.498432,-23.638470], [-46.505222,-23.644470], [-46.508732,-23.653879], [-46.529018,-23.673376], [-46.530060,-23.674240], [-46.531006,-23.673887], [-46.535824,-23.672594], [-46.550446,-23.670782], [-46.555252,-23.671412], [-46.569328,-23.665554], [-46.589046,-23.656385], [-46.609379,-23.673780], [-46.596966,-23.694363], [-46.611385,-23.700336], [-46.613274,-23.702477], [-46.623611,-23.715691], [-46.628723,-23.719667], [-46.640224,-23.716053], [-46.660137,-23.720453], [-46.661640,-23.736404], [-46.650738,-23.747719], [-46.663357,-23.748640], [-46.668175,-23.751165], [-46.670307,-23.753059], [-46.675243,-23.748857], [-46.697948,-23.759642], [-46.704437,-23.759241], [-46.712341,-23.758121], [-46.730198,-23.772120], [-46.712334,-23.757797], [-46.721813,-23.736692], [-46.742771,-23.753277], [-46.744583,-23.752750], [-46.745968,-23.751253], [-46.757469,-23.740726], [-46.772854,-23.745901], [-46.787262,-23.736523], [-46.787766,-23.728901], [-46.786160,-23.728277], [-46.776039,-23.710312], [-46.779282,-23.698111], [-46.791080,-23.691778], [-46.808624,-23.700649], [-46.803776,-23.672266], [-46.804996,-23.656397], [-46.802788,-23.651176], [-46.797924,-23.644251], [-46.796265,-23.623137], [-46.802959,-23.618181], [-46.826305,-23.600309], [-46.839062,-23.587391], [-46.839050,-23.587391], [-46.839020,-23.587391], [-46.827152,-23.587852], [-46.826164,-23.587637], [-46.810661,-23.575171], [-46.800999,-23.566668], [-46.800835,-23.566668], [-46.777554,-23.551752], [-46.790848,-23.536921], [-46.781502,-23.528658], [-46.780987,-23.528107], [-46.776436,-23.515356], [-46.775921,-23.501110], [-46.771030,-23.474346], [-46.786564,-23.456041], [-46.785965,-23.451279], [-46.761784,-23.438797], [-46.759956,-23.434624], [-46.750023,-23.436749], [-46.761784,-23.438797], [-46.785965,-23.449389], [-46.799828,-23.448000], [-46.800686,-23.449869], [-46.793861,-23.458838], [-46.771030,-23.474346], [-46.751450,-23.469988], [-46.724854,-23.466080], [-46.723309,-23.464506], [-46.714294,-23.438580], [-46.714989,-23.436808], [-46.712173,-23.436443], [-46.698288,-23.433640], [-46.690090,-23.426060], [-46.689617,-23.448574], [-46.664257,-23.446474], [-46.658806,-23.426985], [-46.674042,-23.405565], [-46.672455,-23.403276], [-46.657288,-23.405184], [-46.647854,-23.409981], [-46.642323,-23.409870], [-46.629166,-23.403547], [-46.627605,-23.402128], [-46.622372,-23.409224], [-46.598339,-23.424109], [-46.587063,-23.405624], [-46.586838,-23.401819], [-46.566410,-23.390713], [-46.577656,-23.404896], [-46.580700,-23.416588], [-46.565834,-23.437223], [-46.560787,-23.437414], [-46.553310,-23.441908], [-46.532978,-23.446926]]]
                    },
                    Tokyo: {
                        lat: 35.683333,
                        lng: 139.683333,
                        population: 13185502, // 2011 - https://en.wikipedia.org/wiki/Tokyo
                        area: 2187.66,
                        coords: [[[139.650787,35.590141], [139.645844,35.594227], [139.633469,35.603737], [139.614914,35.603695], [139.614227,35.603779], [139.614166,35.603806], [139.606659,35.606609], [139.606308,35.606915], [139.605698,35.607693], [139.591751,35.620056], [139.589539,35.620850], [139.562759,35.627720], [139.563095,35.661617], [139.557785,35.674030], [139.538300,35.690140], [139.524826,35.700165], [139.508423,35.717110], [139.503448,35.718922], [139.496490,35.722683], [139.472000,35.718285], [139.471008,35.718502], [139.465942,35.736927], [139.465347,35.743031], [139.476776,35.741020], [139.496933,35.778519], [139.503876,35.779175], [139.520020,35.772472], [139.537354,35.777714], [139.550827,35.795120], [139.556229,35.808067], [139.591904,35.796604], [139.592789,35.796711], [139.600525,35.792194], [139.633484,35.806675], [139.649704,35.800758], [139.658478,35.800388], [139.661942,35.799786], [139.663406,35.799549], [139.691162,35.817814], [139.695602,35.816551], [139.727402,35.821381], [139.740189,35.825989], [139.765594,35.840305], [139.792953,35.843700], [139.810806,35.848778], [139.817505,35.880150], [139.844971,35.853439], [139.877930,35.889050], [139.887192,35.865959], [139.904358,35.857822], [139.886505,35.860813], [139.866943,35.826721], [139.874054,35.792301], [139.904022,35.792828], [139.919128,35.819206], [139.904358,35.857822], [139.932861,35.835629], [139.955353,35.860744], [139.956207,35.880150], [139.939041,35.896908], [139.941391,35.900276], [139.944168,35.903332], [139.967361,35.881123], [139.976898,35.868465], [139.974716,35.859200], [139.972519,35.848846], [139.952255,35.836323], [139.956467,35.798740], [139.965988,35.765804], [139.987793,35.728676], [139.986755,35.706238], [139.986252,35.701233], [139.985931,35.700817], [139.978180,35.692993], [139.968567,35.680027], [139.945053,35.683357], [139.937408,35.641514], [139.937408,35.641510], [139.932861,35.612652], [139.893051,35.623859], [139.888916,35.585850], [139.901276,35.552898], [139.882385,35.528595], [139.867630,35.525520], [139.855331,35.531502], [139.833984,35.532227], [139.808029,35.523869], [139.786835,35.519333], [139.783051,35.519352], [139.776047,35.520439], [139.766800,35.532665], [139.735794,35.540047], [139.719513,35.538078], [139.717941,35.537270], [139.708832,35.538509], [139.707169,35.538986], [139.700775,35.542110], [139.679901,35.560284], [139.673996,35.561119], [139.649963,35.528595], [139.669815,35.564503], [139.669342,35.566299], [139.650787,35.590141]]]
                    }
                };
            },

            /**
             * @param {string} city
             * @returns {object|bool}   All data for the given city if available, false if not
             */
            getCity: function(city) {
                var data = this._getAll();

                for (var cityName in data) {
                    if (data.hasOwnProperty(cityName) && cityName.toLowerCase() === city.toLowerCase()) {
                        var fullCity = data[cityName];
                        fullCity.name = cityName;

                        return fullCity;
                    }
                }

                return false;
            },

            getPlaces: function() {
                var cities = [];
                var countries = [];

                var data = this._getAll();
                for (var key in data) {
                    if (data.hasOwnProperty(key)) {
                        if ('country' in data[key] && data[key]['country'] === true) {
                            countries.push(key);
                        } else {
                            cities.push(key);
                        }
                    }
                }

                return {
                    'cities': cities,
                    'countries': countries
                };
            }

        };
    })

    .factory('HistoryData', ['basePopulation', 'baseArea', function(basePopulation, baseArea) {
        return {
            get: function() {
                return [
                    {
                        year: 1946,
                        events: [
                            {
                                'virtual': '{city} comes under the auspices of a new, external governing force not fully understood by ' +
                                'its residents. You are issued a new passport. It doesn\'t look like your old one.'
                            }
                        ],
                        population: basePopulation
                    },
                    {
                        year: 1947,
                        events: [
                            {
                                'virtual': 'A new power has begun claiming huge amounts of land in {city} and displacing residents. ' +
                                'Some neighbouring boroughs made noises like they were going to help you out, but ' +
                                'it doesn\'t seem to have worked so well. {city} doesn\'t have an army and the newcomers ' +
                                'have been well supplied by their friends internationally.'
                            }
                        ],
                        population: 1500000 // approx, inferring from '46 & '48
                    },
                    {
                        year: 1948,
                        events: [
                            {
                                'virtual': 'It\'s {year|1948}. Over the past two years {population|750000} residents have been ' +
                                'forced out of the city.',
                                'history': 'By 1948 around 750,000 Palestinians had been forced out of the area. ' +
                                '<a class="source" external href="http://www.unrwa.org/palestine-refugees">UNRWA</a>'
                            }
                        ],
                        population: 872700, // 1948 total, http://www.jewishvirtuallibrary.org/jsource/Society_&_Culture/israel_palestine_pop.html
                        refugees: 750000
                    },
                    {
                        year: 1967,
                        events: [
                            {
                                'virtual': 'Amid heightened tensions, the new residents make a series of preemptive strikes against ' +
                                'friends of {city}. A battle breaks out. {city}\'s casualties are far greater than those ' +
                                'of its opponents.',
                                'history': 'In the Six-Day War of 1967, a further 325,000 Palestinians were forced to ' +
                                'flee. <a class="source" external href="http://www.un.int/wcm/content/site/palestine/cache/offonce/pid/11587">Source</a>'
                            },
                            {
                                'virtual': 'Following the war, its borders are entirely controlled by the new occupier.',
                                'history': '"Israel controls all entry and exit points to the West Bank since it occupied the territory in 1967." ' +
                                    '<a class="source" external href="http://www.maannews.net/eng/ViewDetails.aspx?ID=439273">Source</a>'
                            }
                        ],
                        population: 544600, // West Bank + Gaza, http://unctad.org/en/docs/poecdcseud1.en.pdf p11
                        //refugees: 1100000, // approx - http://www.badil.org/en/press-releases/55-press-releases-2002/323-press261-02 and http://www.un.int/wcm/content/site/palestine/cache/offonce/pid/11587
                        refugees: 2166384, // 1970 - http://www.badil.org/phocadownload/Badil_docs/publications/survey08-09/survey08-09-ch-2.pdf
                        settlers: 100, // 1 settlement, population unknown, http://www.btselem.org/download/200205_land_grab_eng.pdf
                        settlements: 1 // http://www.btselem.org/download/200205_land_grab_eng.pdf
                    },
                    {
                        year: 1972,
                        events: [
                            {
                                'virtual': 'For years after the war, around {population|21000} more original residents ' +
                                'are forced to leave every year.',
                                'history': 'In the years following the Six-Day War, approximately 21,000 Palestinians were ' +
                                    'made to leave annually. <a class="source" external href="http://www.un.int/wcm/content/site/palestine/cache/offonce/pid/11587">Source</a>'
                            }
                        ],
                        population: 1030000, // 1970 - http://en.wikipedia.org/wiki/Palestinian_territories
                        refugees: 2492977, // 1975 - http://www.badil.org/phocadownload/Badil_docs/publications/survey08-09/survey08-09-ch-2.pdf
                        settlers: 10608, // http://www.fmep.org/settlement_info/settlement-info-and-tables/stats-data/israeli-settler-population-1972-2006
                        settlements: 14 // http://www.btselem.org/download/200205_land_grab_eng.pdf
                    },
                    {
                        year: 1983,
                        population: 1360000, // 1980 - http://en.wikipedia.org/wiki/Palestinian_territories, presume US Census
                        refugees: 3237190, // 1985 - http://www.badil.org/phocadownload/Badil_docs/publications/survey08-09/survey08-09-ch-2.pdf
                        settlers: 22800, // http://www.btselem.org/download/200205_land_grab_eng.pdf
                        settlements: 76 // http://www.btselem.org/download/200205_land_grab_eng.pdf
                    },
                    {
                        year: 1989,
                        population: 1900000, // 1990 - http://en.wikipedia.org/wiki/Palestinian_territories, presume US Census
                        refugees: 3792819, // 1990 - http://www.badil.org/phocadownload/Badil_docs/publications/survey08-09/survey08-09-ch-2.pdf
                        //settlers: 199900, // http://www.fmep.org/settlement_info/settlement-info-and-tables/stats-data/israeli-settler-population-1972-2006
                        // Not sure why the disparity above/below is so big - presumably the above includes 'not recognised' / unofficial settlements
                        settlers: 69800, // http://www.btselem.org/download/200205_land_grab_eng.pdf
                        settlements: 115 // http://www.btselem.org/download/200205_land_grab_eng.pdf
                    },
                    {
                        year: 1993,
                        population: 1900000, // 1990 - http://en.wikipedia.org/wiki/Palestinian_territories, presume US Census
                        refugees: 4859029, // 1995 - http://www.badil.org/phocadownload/Badil_docs/publications/survey08-09/survey08-09-ch-2.pdf
                        //settlers: 281800, // http://www.fmep.org/settlement_info/settlement-info-and-tables/stats-data/israeli-settler-population-1972-2006
                        settlers: 257700, // http://www.btselem.org/download/200205_land_grab_eng.pdf
                        settlements: 125 // est, 120 + ? - http://www.btselem.org/download/200205_land_grab_eng.pdf
                    },
                    {
                        year: 2001,
                        events: [
                            {
                                'virtual': 'Education for former {city} folk who have been forced out the city looks starkly different ' +
                                'from that offered to the occupiers\' children. Human rights agencies note that although ' +
                                'a quarter of the children educated in the occupier\'s area are {city} citizens, they are typically ' +
                                'segregated and educated separately in schools with worse conditions.',
                                'history': '"Israel systematically discriminates against Palestinian Arab citizens in its public school system". ' +
                                    '<a class="source" external href="http://www.hrw.org/news/2001/12/04/israeli-schools-separate-not-equal">Human Rights Watch</a>'
                            }
                        ],
                        population: 3110000, // 2000 - http://en.wikipedia.org/wiki/Palestinian_territories, presume US Census
                        refugees: 5497857, // http://www.badil.org/phocadownload/Badil_docs/publications/survey08-09/survey08-09-ch-2.pdf
                        settlers: 387859, // 2000 figure, http://www.fmep.org/settlement_info/settlement-info-and-tables/stats-data/israeli-settler-population-1972-2006
                        // 374900 at http://www.btselem.org/download/200205_land_grab_eng.pdf
                        settlements: 128 // est, 120 + ? - http://www.btselem.org/download/200205_land_grab_eng.pdf
                    },
                    {
                        year: 2002,
                        events: [
                            {
                                'virtual': 'The occupier has started building a wall encompassing most of the remaining areas ' +
                                'of {city}. Most of it is electrified; some is made of concrete but is 8 meters tall. Some outside ' +
                                'are calling it a security fence. Most {city} natives are referring to it as the racist apartheid ' +
                                'wall. The planned area will take more land from inside {city}\'s current borders, and will ' +
                                'encompass illegal settlements under the guise of security.',
                                'history': '"The fence/wall, in its present configuration, violates Israel’s obligations under international humanitarian law". ' +
                                '<a class="source" external href="http://unispal.un.org/unispal.nsf/35a3b6b85ffcfa2f8525718b0058040c/8749dfdc1b131abd85256f20006ee486?OpenDocument">Amnesty International, 2004</a> ' +
                                '<br>"The Expansion and Annexation Wall absorbed about 12% of West Bank land". ' +
                                '<a class="source" external href="http://www.pcbs.gov.ps/site/512/default.aspx?tabID=512&lang=en&ItemID=788&mid=3171&wversion=Staging">PCBS</a>'
                            }
                        ],
                        population: 3110000, // 2000 - http://en.wikipedia.org/wiki/Palestinian_territories, presume US Census
                        refugees: 5639931, // http://www.badil.org/phocadownload/Badil_docs/publications/survey08-09/survey08-09-ch-2.pdf
                        settlers: 414119, // http://www.fmep.org/settlement_info/settlement-info-and-tables/stats-data/israeli-settler-population-1972-2006
                        settlements: 135 // guess from before/ after figures
                    },
                    {
                        year: 2011,
                        events: [
                            {
                                'virtual': '{city} makes a bid to be recognised as a real city by a body that might give it some ' +
                                'international recognition. In retaliation, the occupier freezes tax revenues to the local government ' +
                                'while still collecting tax from citizens, sending the city into financial chaos and threatening all ' +
                                'public services. Nobody knows when revenues will resume.',
                                'history': 'Israel froze Palestinian tax revenues in 2011 after Palestine was admitted as a member ' +
                                'of UN cultural agency UNESCO. It was widely acknowledged as a humanitarian risk. ' +
                                '<a class="source" external href="http://www.maannews.net/eng/ViewDetails.aspx?ID=439273">Source</a>'
                            },
                            {
                                'virtual': 'Settlers now control {area|2399.824} of the land in the original {city}, out of a total area of {area|' + baseArea + '}.',
                                'history': 'By 2009, settler controlled areas of Palestine totalled an estimated 2,399.8 km² ' +
                                'of land within Palestine. ' +
                                '<a class="source" external href="http://www.btselem.org/download/201007_by_hook_and_by_crook_eng.pdf">Source</a>'
                            }
                        ],
                        population: 4120000, // 2010 - http://en.wikipedia.org/wiki/Palestinian_territories#cite_note-105, presumably from US Census Bureau
                        //refugees: 4900000, // 2010 - http://www.unrwa.org/userfiles/2011120434013.pdf
                        refugees: 6641799, // 2008 - http://www.badil.org/phocadownload/Badil_docs/publications/survey08-09/survey08-09-ch-2.pdf
                        settlers: 4900000, // 2009 estimate - http://www.hrw.org/en/node/95059/section/5
                        settlerControlledArea: 2399.824, // km^2, 2009 estimate - http://www.btselem.org/download/201007_by_hook_and_by_crook_eng.pdf
                        settlements: 200 // 2009 lower estimate - http://www.btselem.org/download/201007_by_hook_and_by_crook_eng.pdf
                    },
                    {
                        year: 2012,
                        events: [
                            {
                                'virtual': 'The occupier freezes tax again in response to {city}\'s successful bid for a minimal level ' +
                                'of recognition outside its walls.',
                                'history': '"After the Palestinians won the upgraded U.N. rank of observer state in November 2012, Israel ' +
                                'froze the tax monies and also announced plans for 3,000 homes in a highly sensitive area of the West Bank, ' +
                                'as well as in annexed east Jerusalem, triggering a furious response from the international community." ' +
                                '<a class="source" external href="http://www.dailymail.co.uk/wires/afp/article-2896188/Israel-eyes-tougher-moves-Palestinian-tax-freeze.html">Daily Mail</a>'
                            }
                        ],
                        population: 4120000, // 2010 - http://en.wikipedia.org/wiki/Palestinian_territories#cite_note-105, presumably from US Census Bureau
                        //refugees: 4900000, // 2010 - http://www.unrwa.org/userfiles/2011120434013.pdf
                        refugees: 6641799, // 2008 - http://www.badil.org/phocadownload/Badil_docs/publications/survey08-09/survey08-09-ch-2.pdf
                        settlers: 460838, // 2005 figure - http://www.fmep.org/settlement_info/settlement-info-and-tables/stats-data/israeli-settler-population-1972-2006
                        settlerControlledArea: 2399.824, // km^2, 2009 estimate - http://www.btselem.org/download/201007_by_hook_and_by_crook_eng.pdf
                        settlements: 225 // 2012 estimate - http://www.btselem.org/settlements/statistics
                    },
                    {
                        year: 2014,
                        events: [
                            {
                                'virtual': 'The occupiers have decided to withhold tax revenues from {city} again &ndash; this time as ' +
                                'a result of a bid to attain the legal standing to challenge the occupation\'s injustices internationally.',
                                'history': 'Palestinian tax was frozen (again) in January 2015 after the Palestinian government decided ' +
                                'to join the International Criminal Court. ' +
                                '<a class="source" external href="http://www.wsj.com/articles/israel-withholds-palestinian-tax-revenues-1420312156">The Wall Street Journal</a> Funds were ' +
                                'released only after the 2015 Israeli election.'
                            }
                        ],
                        population: 4120000, // 2010 - http://en.wikipedia.org/wiki/Palestinian_territories#cite_note-105, presumably from US Census Bureau
                        //refugees: 5400000, // http://english.wafa.ps/index.php?action=detail&id=25558
                        refugees: 6641799, // 2008 - http://www.badil.org/phocadownload/Badil_docs/publications/survey08-09/survey08-09-ch-2.pdf
                        settlers: 515000, // 2013 estimate - http://www.btselem.org/settlements/statistics
                        settlerControlledArea: 2399.824, // km^2, 2009 estimate - http://www.btselem.org/download/201007_by_hook_and_by_crook_eng.pdf
                        settlements: 225 // 2012 estimate - http://www.btselem.org/settlements/statistics
                    },
                    {
                        year: 2015,
                        events: [
                            {
                                'virtual': '{population|500} {city} residents are now held by the occupying power with no charge ' +
                                'under administrative detention. Each such detention can be renewed at the last second based on only ' +
                                'secret \'evidence\', amounting to indefinite incarceration without trial. The people of {city} are accused ' +
                                'of crimes for which they are tried for in a language they cannot speak. These actions are condemned by ' +
                                'some internationally &ndash; but the occupier maintains overwhelming financial support.',
                                'history': 'As of October 2014 there were around 500 Palestinian administrative detainees. Administrative ' +
                                'detentions each last 6 months but can run consecutively with no actual charges brought against the prisoner. ' +
                                '<a class="source" external href="http://www.addameer.org/etemplate.php?id=729">Addameer</a>'
                            },
                            {
                                'virtual': 'Over {population|5000000} modern day refugees are living in areas surrounding {city}. They ' +
                                'have their own dedicated United Nations agency.',
                                'history': 'Palestinians number over 5 million refugees today. UNRWA is the UN organisation responsible for ' +
                                'monitoring them. <a class="source" external href="http://www.unrwa.org/palestine-refugees">UNRWA</a>'
                            },
                            {
                                'history': 'Refugees represent 70% of the Palestinians in the world today. ' +
                                '<a class="source" external href="http://www.caabu.org/sites/default/files/resources/Refugees%20and%20Israel%20Palestine_0.pdf">CAABU</a>'
                            }
                        ],
                        population: 4120000, // 2010 - http://en.wikipedia.org/wiki/Palestinian_territories#cite_note-105, presumably from US Census Bureau
                        //refugees: 5400000, // 2014 - http://english.wafa.ps/index.php?action=detail&id=25558
                        refugees: 6641799, // 2008 - http://www.badil.org/phocadownload/Badil_docs/publications/survey08-09/survey08-09-ch-2.pdf
                        settlers: 515000, // 2013 estimate - http://www.btselem.org/settlements/statistics
                        settlerControlledArea: 2399.824, // km^2, 2009 estimate - http://www.btselem.org/download/201007_by_hook_and_by_crook_eng.pdf
                        settlements: 225 // 2012 estimate - http://www.btselem.org/settlements/statistics
                    }
                ]
            }
        }
    }])

    .factory('MapHelper', ['$filter', '$window', 'leafletData', function($filter, $window, leafletData) {
        return {
            /**
             * Takes a city object and returns an object with 'center', 'paths' and 'geojson' keys suitable for using
             * directly with Leaflet directive
             *
             * @param {object} city Should have keys 'name', 'lat', 'lng', 'area' and optionally 'coords'
             * @param {int} refugees (Population-adjusted) number of refugees for current render
             * @param {int} numMarkers Number of settlement markers to draw within city/country
             * @returns {{center: {lat: *, lng: *, zoom: number}, paths: {}, geojson: {}}}
             */
            buildLeafletData: function(city, refugees, numMarkers) {
                var colour = (refugees > 0 ? '#f99' : '#9f9');
                var geojson = {};
                var paths = {};
                var circleRadius = Math.sqrt(city.area / Math.PI) * 1000; // in m
                var geometry = false;

                if ('coords' in city) {
                    geometry = {
                        "type": "Polygon",
                        "coordinates": city['coords']
                    };
                } else if('multicoords' in city) {
                    geometry = {
                        "type": "MultiPolygon",
                        "coordinates": city['multicoords']
                    };
                }

                if (geometry !== false) {
                    geojson = {
                        data: {
                            type: 'FeatureCollection',
                            features: [
                                {
                                    type: 'Feature',
                                    properties: {name: city.name},
                                    geometry: geometry
                                }
                            ]
                        },
                        style: {
                            fillColor: colour,
                            weight: 2,
                            opacity: 1,
                            color: '#fff',
                            dashArray: '3',
                            fillOpacity: 0.7
                        }
                    }
                } else {
                    paths = {
                        circle: {
                            type: 'circle',
                            weight: 2,
                            color: colour,
                            radius: circleRadius,
                            latlngs: {lat: city.lat, lng: city.lng},
                            message: '<h3>An approximation of ' + city.name + '!</h3>' +
                            '<p>For now we\'re just using a circle with its area of ' + $filter('number')(city.area) +
                            'km².</p>'
                        }
                    }
                }

                var markers = this._buildMarkers(numMarkers, city.lat, city.lng, city.area, geojson);

                // Adjust zoom level from either 11 or 10, for desktop and mobile sizes respectively
                var baseZoom = $window.innerWidth > 700 ? 11 : 10;

                return {
                    center: {
                        lat: city.lat,
                        lng: city.lng,
                        zoom: Math.round(baseZoom - Math.pow(city.area, 1/2.7) / 15)
                    },
                    paths: paths,
                    geojson: geojson,
                    markers: markers
                };
            },

            /**
             * Given an existing markers array and a target number, get a new markers array
             *
             * @param {int}     requiredMarkers     Number of markers desired on completion
             * @param {array}   markers             Starting marker set
             * @param {float}   lat                 Latitude
             * @param {float}   lng                 Longitude
             * @param {number}  area                Area in km^2
             * @param {object}  geojson             Geojson data, may be {}
             * @returns {array}                     Smaller array of markers
             */
            getUpdatedMarkers: function(requiredMarkers, markers, lat, lng, area, geojson) {
                if (requiredMarkers === markers.length) {
                    return markers;
                }

                if (requiredMarkers > markers.length) {
                    return this._addMarkers(requiredMarkers, markers, lat, lng, area, geojson);
                }

                if (requiredMarkers < markers.length) {
                    return this._removeMarkers(requiredMarkers, markers);
                }
            },

            _addMarkers: function(requiredMarkers, markers, lat, lng, area, geojson) {
                var mapHelper = this;
                var radius = Math.sqrt(area / Math.PI);

                if (geojson === {}) { // Use circle approximation where we have no geojson outline
                    while (markers.length < requiredMarkers) {
                        markers.push(this._generatePoint(lat, lng, radius));
                    }
                } else {
                    leafletData.getGeoJSON().then(function(leafletGeojson) {
                        var attempts = 0;
                        while (markers.length < requiredMarkers) {
                            // Try random points a little beyond the city's circle radius, then check if the point's
                            // inside the real city outline
                            var possMarker = mapHelper._generatePoint(lat, lng, radius * 1.3);
                            // N.B. leafletPip requires params in order [lng, lat] by default
                            var matches = leafletPip.pointInLayer([possMarker.lng, possMarker.lat], leafletGeojson, true);
                            if (matches.length > 0) {
                                markers.push(possMarker);
                            }

                            if (attempts++ > requiredMarkers * 4 + 10) {
                                console.log('Stopping marker generation - not finished after ' + attempts + ' attempts');
                                break;
                            }
                        }
                    });
                }

                return markers;
            },

            _removeMarkers: function(requiredMarkers, markers) {
                return markers.slice(0, requiredMarkers);
            },

            _buildMarkers: function (requiredMarkers, lat, lng, area, geojson) {
                return this._addMarkers(requiredMarkers, [], lat, lng, area, geojson);
            },

            /**
             * Returns a Leaflet-ready object for a marker point a random distance up to `radius` from [`lat`, `lng`].
             *
             * @param {float} lat       Centre point latitude
             * @param {float} lng       Centre point longitude
             * @param {number} radius    Maximum radius to move from centre, in km
             * @returns {{lat: *, lng: *, draggable: boolean}}
             * @private
             */
            _generatePoint: function(lat, lng, radius) {
                // Based on http://stackoverflow.com/a/2188606/2803757
                var dist = Math.random() * radius
                    * 2     // circumference from radius
                    * 1000; // m from km
                var bearing = Math.random() * Math.PI * 2;

                var dx = dist * Math.sin(bearing);
                var dy = dist * Math.cos(bearing);
                var deltaLat = dy / 110540;
                var deltaLng = dx / (111320 * Math.cos(lat));

                var newLat = lat + deltaLat;
                var newLng = lng + deltaLng;

                return {
                    lat: newLat,
                    lng: newLng,
                    draggable: false,
                    icon: {
                        type: 'awesomeMarker',
                        prefix: 'fa',
                        icon: 'home',
                        markerColor: 'lightblue',
                        iconColor: 'white'
                    }
                };
            }
        }
    }])
;
